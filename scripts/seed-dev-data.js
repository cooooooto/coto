#!/usr/bin/env node

/**
 * Script para poblar la base de datos de desarrollo con datos de prueba
 * Uso: node scripts/seed-dev-data.js [--reset]
 */

const { createClient } = require('@supabase/supabase-js');

// Configuraci√≥n de desarrollo
const devConfig = {
  url: process.env.NEXT_PUBLIC_SUPABASE_DEV_URL || process.env.NEXT_PUBLIC_SUPABASE_URL,
  key: process.env.SUPABASE_DEV_SERVICE_ROLE_KEY || process.env.SUPABASE_SERVICE_ROLE_KEY,
};

// Datos de prueba
const seedData = {
  profiles: [
    {
      id: '00000000-0000-0000-0000-000000000001',
      email: 'admin@test.dev',
      full_name: 'Admin Test User',
      role: 'admin',
    },
    {
      id: '00000000-0000-0000-0000-000000000002',
      email: 'developer@test.dev',
      full_name: 'Developer Test User',
      role: 'member',
    },
    {
      id: '00000000-0000-0000-0000-000000000003',
      email: 'viewer@test.dev',
      full_name: 'Viewer Test User',
      role: 'viewer',
    },
  ],
  projects: [
    {
      id: '11111111-1111-1111-1111-111111111111',
      name: 'Sistema de Autenticaci√≥n',
      description: 'Implementaci√≥n del sistema de login y registro de usuarios con OAuth',
      deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 d√≠as
      status: 'In-Progress',
      phase: 'DEV',
      progress: 45,
      owner_id: '00000000-0000-0000-0000-000000000001',
    },
    {
      id: '22222222-2222-2222-2222-222222222222',
      name: 'API de Productos',
      description: 'Desarrollo de endpoints RESTful para gesti√≥n de productos',
      deadline: new Date(Date.now() + 45 * 24 * 60 * 60 * 1000).toISOString(), // 45 d√≠as
      status: 'To-Do',
      phase: 'DEV',
      progress: 0,
      owner_id: '00000000-0000-0000-0000-000000000002',
    },
    {
      id: '33333333-3333-3333-3333-333333333333',
      name: 'Dashboard Analytics',
      description: 'Panel de control con m√©tricas y gr√°ficos en tiempo real',
      deadline: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), // Vencido hace 10 d√≠as
      status: 'Done',
      phase: 'PROD',
      progress: 100,
      owner_id: '00000000-0000-0000-0000-000000000001',
    },
    {
      id: '44444444-4444-4444-4444-444444444444',
      name: 'Integraci√≥n con Jira',
      description: 'Conectar la aplicaci√≥n con Jira para sincronizaci√≥n de tareas',
      deadline: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString(), // 60 d√≠as
      status: 'In-Progress',
      phase: 'INT',
      progress: 75,
      owner_id: '00000000-0000-0000-0000-000000000002',
    },
  ],
  tasks: [
    // Tareas para Sistema de Autenticaci√≥n
    {
      project_id: '11111111-1111-1111-1111-111111111111',
      name: 'Configurar Supabase Auth',
      completed: true,
      assigned_to: '00000000-0000-0000-0000-000000000001',
    },
    {
      project_id: '11111111-1111-1111-1111-111111111111',
      name: 'Crear formularios de login/registro',
      completed: true,
      assigned_to: '00000000-0000-0000-0000-000000000002',
    },
    {
      project_id: '11111111-1111-1111-1111-111111111111',
      name: 'Implementar OAuth con Google',
      completed: false,
      assigned_to: '00000000-0000-0000-0000-000000000001',
    },
    {
      project_id: '11111111-1111-1111-1111-111111111111',
      name: 'Validaci√≥n de roles y permisos',
      completed: false,
      assigned_to: '00000000-0000-0000-0000-000000000002',
    },
    // Tareas para API de Productos
    {
      project_id: '22222222-2222-2222-2222-222222222222',
      name: 'Dise√±ar esquema de base de datos',
      completed: false,
      assigned_to: '00000000-0000-0000-0000-000000000002',
    },
    {
      project_id: '22222222-2222-2222-2222-222222222222',
      name: 'Crear endpoints CRUD',
      completed: false,
      assigned_to: '00000000-0000-0000-0000-000000000002',
    },
    // Tareas para Dashboard Analytics
    {
      project_id: '33333333-3333-3333-3333-333333333333',
      name: 'Configurar Recharts',
      completed: true,
      assigned_to: '00000000-0000-0000-0000-000000000001',
    },
    {
      project_id: '33333333-3333-3333-3333-333333333333',
      name: 'Implementar gr√°ficos de tiempo real',
      completed: true,
      assigned_to: '00000000-0000-0000-0000-000000000001',
    },
    // Tareas para Integraci√≥n con Jira
    {
      project_id: '44444444-4444-4444-4444-444444444444',
      name: 'Configurar API de Jira',
      completed: true,
      assigned_to: '00000000-0000-0000-0000-000000000002',
    },
    {
      project_id: '44444444-4444-4444-4444-444444444444',
      name: 'Sincronizaci√≥n bidireccional',
      completed: false,
      assigned_to: '00000000-0000-0000-0000-000000000002',
    },
  ],
  project_members: [
    {
      project_id: '11111111-1111-1111-1111-111111111111',
      user_id: '00000000-0000-0000-0000-000000000002',
      role: 'member',
    },
    {
      project_id: '22222222-2222-2222-2222-222222222222',
      user_id: '00000000-0000-0000-0000-000000000001',
      role: 'admin',
    },
    {
      project_id: '33333333-3333-3333-3333-333333333333',
      user_id: '00000000-0000-0000-0000-000000000003',
      role: 'viewer',
    },
    {
      project_id: '44444444-4444-4444-4444-444444444444',
      user_id: '00000000-0000-0000-0000-000000000001',
      role: 'admin',
    },
  ],
  comments: [
    {
      project_id: '11111111-1111-1111-1111-111111111111',
      user_id: '00000000-0000-0000-0000-000000000001',
      content: 'El sistema de autenticaci√≥n est√° progresando bien. Ya tenemos la base configurada.',
    },
    {
      project_id: '11111111-1111-1111-1111-111111111111',
      user_id: '00000000-0000-0000-0000-000000000002',
      content: 'Los formularios est√°n listos. Ahora trabajar√© en la integraci√≥n con OAuth.',
    },
    {
      project_id: '22222222-2222-2222-2222-222222222222',
      user_id: '00000000-0000-0000-0000-000000000002',
      content: 'Comenzando el an√°lisis de requisitos para la API de productos.',
    },
    {
      project_id: '44444444-4444-4444-4444-444444444444',
      user_id: '00000000-0000-0000-0000-000000000002',
      content: 'La configuraci√≥n inicial con Jira est√° completa. Probando la sincronizaci√≥n.',
    },
  ],
  phase_transitions: [
    {
      project_id: '44444444-4444-4444-4444-444444444444',
      from_phase: 'DEV',
      to_phase: 'INT',
      status: 'approved',
      requested_by: '00000000-0000-0000-0000-000000000002',
      approved_by: '00000000-0000-0000-0000-000000000001',
      comment: 'Funcionalidad b√°sica completada, listo para testing de integraci√≥n',
      requested_at: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
      reviewed_at: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString(),
    },
    {
      project_id: '33333333-3333-3333-3333-333333333333',
      from_phase: 'PRE',
      to_phase: 'PROD',
      status: 'approved',
      requested_by: '00000000-0000-0000-0000-000000000001',
      approved_by: '00000000-0000-0000-0000-000000000001',
      comment: 'Testing completado exitosamente, listo para producci√≥n',
      requested_at: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
      reviewed_at: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(),
    },
  ],
};

// Funci√≥n principal
async function seedDatabase(reset = false) {
  console.log('üå± Iniciando seeding de base de datos de desarrollo...');
  
  if (!devConfig.url || !devConfig.key) {
    console.error('‚ùå Configuraci√≥n de desarrollo no encontrada');
    console.error('Aseg√∫rate de tener configuradas las variables:');
    console.error('- NEXT_PUBLIC_SUPABASE_DEV_URL');
    console.error('- SUPABASE_DEV_SERVICE_ROLE_KEY');
    process.exit(1);
  }
  
  const supabase = createClient(devConfig.url, devConfig.key);
  
  try {
    // Verificar conexi√≥n
    const { error: connectionError } = await supabase.from('profiles').select('count', { count: 'exact', head: true });
    if (connectionError) {
      throw new Error(`Error de conexi√≥n: ${connectionError.message}`);
    }
    
    console.log('‚úÖ Conexi√≥n a desarrollo verificada');
    
    if (reset) {
      console.log('üßπ Limpiando datos existentes...');
      await supabase.from('comments').delete().neq('id', '00000000-0000-0000-0000-000000000000');
      await supabase.from('phase_transitions').delete().neq('id', '00000000-0000-0000-0000-000000000000');
      await supabase.from('project_members').delete().neq('id', '00000000-0000-0000-0000-000000000000');
      await supabase.from('tasks').delete().neq('id', '00000000-0000-0000-0000-000000000000');
      await supabase.from('projects').delete().neq('id', '00000000-0000-0000-0000-000000000000');
      await supabase.from('profiles').delete().neq('id', '00000000-0000-0000-0000-000000000000');
      console.log('‚úÖ Datos limpiados');
    }
    
    // Insertar datos de prueba
    console.log('üìù Insertando perfiles...');
    const { error: profilesError } = await supabase.from('profiles').upsert(seedData.profiles);
    if (profilesError) throw profilesError;
    console.log(`‚úÖ ${seedData.profiles.length} perfiles insertados`);
    
    console.log('üìù Insertando proyectos...');
    const { error: projectsError } = await supabase.from('projects').upsert(seedData.projects);
    if (projectsError) throw projectsError;
    console.log(`‚úÖ ${seedData.projects.length} proyectos insertados`);
    
    console.log('üìù Insertando tareas...');
    const { error: tasksError } = await supabase.from('tasks').upsert(seedData.tasks);
    if (tasksError) throw tasksError;
    console.log(`‚úÖ ${seedData.tasks.length} tareas insertadas`);
    
    console.log('üìù Insertando miembros de proyecto...');
    const { error: membersError } = await supabase.from('project_members').upsert(seedData.project_members);
    if (membersError) throw membersError;
    console.log(`‚úÖ ${seedData.project_members.length} miembros insertados`);
    
    console.log('üìù Insertando comentarios...');
    const { error: commentsError } = await supabase.from('comments').upsert(seedData.comments);
    if (commentsError) throw commentsError;
    console.log(`‚úÖ ${seedData.comments.length} comentarios insertados`);
    
    console.log('üìù Insertando transiciones de fase...');
    const { error: transitionsError } = await supabase.from('phase_transitions').upsert(seedData.phase_transitions);
    if (transitionsError) throw transitionsError;
    console.log(`‚úÖ ${seedData.phase_transitions.length} transiciones insertadas`);
    
    console.log('üéâ Seeding completado exitosamente!');
    console.log('');
    console.log('üë• Usuarios de prueba creados:');
    seedData.profiles.forEach(profile => {
      console.log(`  - ${profile.email} (${profile.role})`);
    });
    
  } catch (error) {
    console.error('üí• Error durante el seeding:', error.message);
    process.exit(1);
  }
}

// Ejecutar si es llamado directamente
if (require.main === module) {
  const reset = process.argv.includes('--reset');
  seedDatabase(reset);
}

module.exports = { seedDatabase, seedData };
